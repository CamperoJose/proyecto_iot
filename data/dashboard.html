<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Dashboard</title>
  <style>
    /* Add your styles here */
  </style>
</head>

<body>
  <h1>Activity Dashboard</h1>

  <label for="userSelect">Select User:</label>
  <select id="userSelect" onchange="filterData()">
    <option value="">All</option>
    <!-- Populate with user options dynamically -->
  </select>

  <label for="roomSelect">Select Room:</label>
  <select id="roomSelect" onchange="filterData()">
    <option value="">All</option>
    <!-- Populate with room options dynamically -->
  </select>

  <label for="startDate">Start date</label>
  <input type="date" id="startDate" onchange="filterData()">

  <label for="endDate">End date</label>
  <input type="date" id="endDate" onchange="filterData()">

  <div id="timelineChart">
    <!-- Display timeline chart here -->
  </div>

  <button id="downloadButton">Download Data</button>
  <button id="downloadReport">Download Report</button>
  <button id="downloadScopes">Download Scopes</button>

  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script>
    async function fetchData(userId, ledId, start_date, end_date) {
      try {
        let url = 'http://localhost:3000/api/v1/actions/count'
        if (userId || ledId || start_date || end_date) {
          url += '?'
        }
        if (userId) {
          url += `userId=${userId}&`
        }
        if (ledId) {
          url += `ledId=${ledId}&`
        }
        if (start_date && end_date) {
          url += `startDate=${start_date}&endDate=${end_date}`
        }
        console.log(url)
        const response = await fetch(url);
        const data = await response.json();
        console.log(data);
        return data;
      } catch (error) {
        alert('No data found');
      }
    }

    async function fetchUsers() {
      try {
        const response = await fetch('http://localhost:3000/api/v1/users');
        const users = await response.json();
        console.log(users)

        // Populate the user dropdown
        const userSelect = document.getElementById('userSelect');
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.USER_ID;
          option.text = user.USERNAME;
          userSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching users:', error);
      }
    }

    async function fetchRooms() {
      try {
        const response = await fetch('http://localhost:3000/api/v1/leds');
        const rooms = await response.json();
        console.log(rooms)

        // Populate the room dropdown
        const roomSelect = document.getElementById('roomSelect');
        rooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room.LED_ID;
          option.text = room.LED_NAME;
          roomSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching rooms:', error);
      }
    }

    async function filterData() {
      const userSelect = document.getElementById('userSelect');
      const roomSelect = document.getElementById('roomSelect');

      const selectedUserId = userSelect.value;
      const selectedRoomId = roomSelect.value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      try {
        const data = await fetchData(selectedUserId, selectedRoomId, startDate, endDate);

        // Update the timeline chart with filtered data (you need to implement this part)
        updateTimelineChart(data);
      } catch (error) {
        console.log('Error fetching data:', error)
      }


    }

    function updateTimelineChart(data) {
      // Prepare the data for the timeline chart
      const chartData = data.map(action => ({
        x: new Date(action.DATE + 'T' + action.HOUR + ':00:00'), // FIXME esto quizÃ¡ se tire si action.HOUR no tiene un 0 por delante
        count: action.COUNT
      }));

      console.log(chartData);


      // Generate the line chart
      Highcharts.chart('timelineChart', {
        chart: {
          type: 'line'
        },
        title: {
          text: 'Timeline Chart'
        },
        xAxis: {
          type: 'datetime',
          title: {
            text: 'Date'
          }
        },
        yAxis: {
          title: {
            text: 'Count'
          }
        },
        series: [{
          name: 'Count',
          data: chartData.map(d => [d.x.getTime(), d.count])
        }]
      });
    }

    // DOWNLOAD LINE CHART AS CSV
    // Fetch initial data and populate dropdowns
    document.addEventListener('DOMContentLoaded', async () => {
      await fetchUsers();
      await fetchRooms();
      filterData(); // Fetch and display data initially
    });

    // Add this function to convert data to CSV format
    function convertDataToCSV(data) {
      const csvContent =
        "data:text/csv;charset=utf-8," +
        "Date, Hour,Count\n" +
        data.map(d => `${d.DATE}, ${d.HOUR}`+":00:00"+`,${d.COUNT}`).join("\n");

      return encodeURI(csvContent);
    }

    // Add an event listener to the download button
    document.getElementById("downloadButton").addEventListener("click", () => {
      const userSelect = document.getElementById("userSelect");
      const roomSelect = document.getElementById("roomSelect");

      const selectedUserId = userSelect.value;
      const selectedRoomId = roomSelect.value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      fetchData(selectedUserId, selectedRoomId, startDate, endDate)
        .then(data => {
          const csvContent = convertDataToCSV(data);
          const downloadLink = document.createElement("a");
          downloadLink.href = csvContent;
          downloadLink.download = "timeline_data.csv";
          downloadLink.click();
        })
        .catch(error => {
          console.log("Error fetching data:", error);
        });
    });

    // DOWNLOAD ALL ACTIONS AS CSV
    // fetch all actions
    async function fetchAllActions() {
      try {
        const response = await fetch('http://localhost:3000/api/v1/actions/summary');
        const data = await response.json();
        console.log(data);
        return data;
      } catch (error) {
        alert('No data found');
      }
    }

    // Add this function to convert data to CSV format
    function convertDataToCSVreport(data) {
      console.log(data[0]);
      const csvContent =
        "data:text/csv;charset=utf-8," +
        "Nro, Fecha, Hora, Habitacion, Persona, Admin, Accion\n" +
        data.map(d => `${d.n}, ${d.fecha}, ${d.hora}, ${d.habitacion}, ${d.persona}, ${d.admin}, ${d.accion}`).join("\n");

      return encodeURI(csvContent);
    }

    // Add an event listener to the download report button
    document.getElementById("downloadReport").addEventListener("click", () => {
      fetchAllActions()
        .then(data => {
          const csvContent = convertDataToCSVreport(data);
          const downloadLink = document.createElement("a");
          downloadLink.href = csvContent;
          downloadLink.download = "report_data.csv";
          downloadLink.click();
        })
        .catch(error => {
          console.log("Error fetching data:", error);
        });
    });

    // DOWNLOAD SCOPES AS CSV
    // fetch all scopes
    async function fetchAllScopes() {
      try {
        const response = await fetch('http://localhost:3000/api/v1/devices/summary');
        const data = await response.json();
        console.log(data);
        return data;
      } catch (error) {
        alert('No data found');
      }
    }

    // Add this function to convert data to CSV format
    function convertDataToCSVscopes(data) {
      const csvContent =
        "data:text/csv;charset=utf-8," +
        "NombreDispositivo, IPv4, Propietario, Privilegios, Scope\n" +
        data.map(d => `${d.DeviceName}, ${d.DeviceIPv4}, ${d.OwnerName}, ${d.GrantedScopes}`).join("\n");

      return encodeURI(csvContent);
    }

    // Add an event listener to the download scopes button
    document.getElementById("downloadScopes").addEventListener("click", () => {
      fetchAllScopes()
        .then(data => {
          const csvContent = convertDataToCSVscopes(data);
          const downloadLink = document.createElement("a");
          downloadLink.href = csvContent;
          downloadLink.download = "scopes_data.csv";
          downloadLink.click();
        })
        .catch(error => {
          console.log("Error fetching data:", error);
        });
    });


  </script>
</body>

</html>